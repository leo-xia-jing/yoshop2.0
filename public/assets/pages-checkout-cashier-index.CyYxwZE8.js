import{a7 as e,o as a,c as t,w as o,a as s,b as n,f as r,t as l,F as d,e as i,n as c,k as m,l as u,i as y,$ as h,R as p,A as f,r as _,q as g,a1 as P,d as T}from"./index-Drdq8Rgk.js";import{_ as I}from"./u-modal.BSqzbzYo.js";import{r as C}from"./uni-app.es.D6sSmWWN.js";import{e as S,a as v,p as x,b}from"./wechat.CsXgQhWp.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{P as E}from"./Method.JI5O4joI.js";import{P as k}from"./OrderType.CndSo2_p.js";import"./u-loading.BZWg5Nq1.js";import"./u-popup.DpV25bUY.js";import"./u-icon.BZ5A4twx.js";import"./Client.CexyBN83.js";const A=w({props:{date:{type:String,default:""},separator:{type:String,default:"zh"},theme:{type:String,default:"text"},customBgColor:{type:String,default:"#252525"}},data:()=>({dynamic:{day:"0",hou:"00",min:"00",sec:"00"},separatorText:{day:"天",hou:"时",min:"分",sec:"秒"}}),created(){this.setSeparatorText(),this.onTime()},methods:{setSeparatorText(){const e=this.separatorText;"colon"===this.separator&&(e.day=":",e.hou=e.min=":",e.sec=""),this.separatorText=e},onTime(a=0){const t=this,o={},s=(new Date).getTime(),n=new Date(e(t.date)).getTime();if(n-s<=0)return!1;const r=(n-s)/1e3,l=parseInt(r/86400),d=parseInt(r%86400/3600),i=parseInt(r%86400%3600/60),c=parseInt(r%86400%3600%60);o.day=l,o.hou=t.timeFormat(d),o.min=t.timeFormat(i),o.sec=t.timeFormat(c),t.dynamic=o;const m=t.isEnd();m&&a>0&&t.$emit("finish"),m||setTimeout((()=>{t.onTime(++a)}),100)},isEnd(){const{dynamic:e}=this;return"00"==e.day&&"00"==e.hou&&"00"==e.min&&"00"==e.sec},timeFormat:e=>e<10?"0"+e:e}},[["render",function(e,h,p,f,_,g){const P=u,T=y;return p.date?(a(),t(T,{key:0,class:"count-down"},{default:o((()=>[s(T,{class:m([`${p.theme}-theme`,`separator-${p.separator}`])},{default:o((()=>[_.dynamic.day>0?(a(),n(d,{key:0},[s(P,{class:"dynamic-value"},{default:o((()=>[r(l(_.dynamic.day),1)])),_:1}),s(P,{class:"separator"},{default:o((()=>[r(l(_.separatorText.day),1)])),_:1})],64)):i("",!0),s(P,{class:"dynamic-value",style:c({backgroundColor:p.customBgColor})},{default:o((()=>[r(l(_.dynamic.hou),1)])),_:1},8,["style"]),s(P,{class:"separator"},{default:o((()=>[r(l(_.separatorText.hou),1)])),_:1}),s(P,{class:"dynamic-value",style:c({backgroundColor:p.customBgColor})},{default:o((()=>[r(l(_.dynamic.min),1)])),_:1},8,["style"]),s(P,{class:"separator"},{default:o((()=>[r(l(_.separatorText.min),1)])),_:1}),s(P,{class:"dynamic-value",style:c({backgroundColor:p.customBgColor})},{default:o((()=>[r(l(_.dynamic.sec),1)])),_:1},8,["style"]),s(P,{class:"separator"},{default:o((()=>[r(l(_.separatorText.sec),1)])),_:1})])),_:1},8,["class"])])),_:1})):i("",!0)}],["__scopeId","data-v-bc038875"]]),D="cashier/orderInfo",N="cashier/orderPay",M="cashier/tradeQuery";const L={[E.WECHAT.value]:"icon-wechat-pay",[E.ALIPAY.value]:"icon-alipay",[E.BALANCE.value]:"icon-balance-pay"},U={[E.WECHAT.value]:"微信",[E.ALIPAY.value]:"支付宝"};const j=w({components:{CountDown:A},data:()=>({isLoading:!0,disabled:!1,PayMethodEnum:E,PayMethodIconEnum:L,PayMethodClientNameEnum:U,curPaymentItem:null,orderId:null,order:{},personal:{balance:"0.00"},methods:[],showConfirmModal:!1,tempUnifyData:{outTradeNo:"",method:""}}),onLoad({orderId:e}){this.orderId=Number(e)},onShow(){this.getCashierInfo()},methods:{getCashierInfo(){const e=this;var a,t;e.isLoading=!0,(a=e.orderId,t={client:e.platform},h.get(D,{orderId:a,...t})).then((a=>{e.order=a.data.order,e.personal=a.data.personal,e.methods=a.data.paymentMethods,e.isLoading=!1,e.setDefaultPayType(),e.checkOrderPayStatus(),this.performance()}))},setDefaultPayType(){const e=this;if(e.disabled)return;if(e.curPaymentItem)return;const a=e.methods.findIndex((e=>1==e.is_default));a>-1&&e.handleSelectPayType(a)},checkOrderPayStatus(){const e=this;e.order.pay_status==k.SUCCESS.value&&(e.$toast("恭喜您，订单已付款成功"),e.onSuccessNav())},handleSelectPayType(e){this.curPaymentItem=this.methods[e]},performance(){const e=this;if(e.order.pay_status==k.PENDING.value){const a=(e=>{const a=P.get("tempUnifyData_"+e);return a?(P.remove("tempUnifyData_"+e),a):null})(e.orderId);a&&(e.tempUnifyData=a,e.showConfirmModal=!0)}},handleSubmit(){const e=this;var a,t;e.curPaymentItem?e.disabled||(e.disabled=!0,(a=e.orderId,t={method:e.curPaymentItem.method,client:e.platform,extra:e.getExtraAsUnify(e.curPaymentItem.method)},h.post(N,{orderId:a,...t})).then((a=>e.onSubmitCallback(a))).finally((a=>setTimeout((()=>e.disabled=!1),10)))):e.$toast("您还没有选择支付方式")},getExtraAsUnify:e=>e===E.ALIPAY.value?S():e===E.WECHAT.value?v():{},onSubmitCallback(e){const a=this,t=a.curPaymentItem.method,o=e.data.payment;t===E.BALANCE.value&&a.onShowSuccess(e),t===E.ALIPAY.value&&(console.log("paymentData",o),x({orderKey:a.orderId,...o}).then((e=>a.onPaySuccess(e))).catch((e=>a.onPayFail(e)))),t===E.WECHAT.value&&(console.log("paymentData",o),b({orderKey:a.orderId,...o}).then((e=>a.onPaySuccess(e))).catch((e=>a.onPayFail(e))))},onPaySuccess({res:e,option:{isRequireQuery:a,outTradeNo:t,method:o}}){if(a)return this.onTradeQuery(t,o),!0;this.onShowSuccess(e)},onShowSuccess({message:e}){this.$toast(e||"订单支付成功"),this.onSuccessNav()},onPayFail(e){console.log("onPayFail",e);const a=e.message||"订单未支付";this.$error(a)},onTradeQuery(e,a){const t=this;var o;(o={outTradeNo:e,method:a,client:t.platform},h.get(M,o)).then((e=>e.data.isPay?t.onShowSuccess(e):t.onPayFail(e))).finally((()=>t.showConfirmModal=!1))},onSuccessNav(){uni.$emit("syncRefresh",!0);const e=p(),a=e.length<2?null:e[e.length-2],t=["pages/order/index","pages/order/detail"];setTimeout((()=>{a&&f(a.route,t)?uni.navigateBack():this.$navTo("pages/order/index",{},"redirectTo")}),1200)}}},[["render",function(e,h,p,f,P,S){const v=u,x=_("count-down"),b=y,w=C(g("u-modal"),I);return P.isLoading?i("",!0):(a(),t(b,{key:0,class:"container",style:c(e.appThemeStyle)},{default:o((()=>[s(b,{class:"order-info"},{default:o((()=>[P.order.showExpiration?(a(),t(b,{key:0,class:"order-countdown"},{default:o((()=>[s(v,{class:"m-r-6"},{default:o((()=>[r("剩余时间")])),_:1}),s(x,{date:P.order.expirationTime,separator:"zh",theme:"text"},null,8,["date"])])),_:1})):i("",!0),s(b,{class:"order-amount"},{default:o((()=>[s(v,{class:"unit"},{default:o((()=>[r("￥")])),_:1}),s(v,{class:"amount"},{default:o((()=>[r(l(P.order.pay_price),1)])),_:1})])),_:1})])),_:1}),s(b,{class:"payment-method"},{default:o((()=>[(a(!0),n(d,null,T(P.methods,((e,n)=>(a(),t(b,{key:n,class:"pay-item dis-flex flex-x-between",onClick:e=>S.handleSelectPayType(n)},{default:o((()=>[s(b,{class:"item-left dis-flex flex-y-center"},{default:o((()=>[s(b,{class:m(["item-left_icon",[e.method]])},{default:o((()=>[s(v,{class:m(["iconfont",[P.PayMethodIconEnum[e.method]]])},null,8,["class"])])),_:2},1032,["class"]),s(b,{class:"item-left_text"},{default:o((()=>[s(v,null,{default:o((()=>[r(l(P.PayMethodEnum[e.method].name),1)])),_:2},1024)])),_:2},1024),e.method===P.PayMethodEnum.BALANCE.value?(a(),t(b,{key:0,class:"user-balance"},{default:o((()=>[s(v,null,{default:o((()=>[r("(可用￥"+l(P.personal.balance)+"元)",1)])),_:1})])),_:1})):i("",!0)])),_:2},1024),P.curPaymentItem&&P.curPaymentItem.method==e.method?(a(),t(b,{key:0,class:"item-right col-m"},{default:o((()=>[s(v,{class:"iconfont icon-check"})])),_:1})):i("",!0)])),_:2},1032,["onClick"])))),128))])),_:1}),s(b,{class:"footer-fixed"},{default:o((()=>[s(b,{class:"btn-wrapper"},{default:o((()=>[s(b,{class:m(["btn-item btn-item-main",{disabled:P.disabled}]),onClick:h[0]||(h[0]=e=>S.handleSubmit())},{default:o((()=>[r("确认支付")])),_:1},8,["class"])])),_:1})])),_:1}),P.tempUnifyData?(a(),t(w,{key:0,modelValue:P.showConfirmModal,"onUpdate:modelValue":h[1]||(h[1]=e=>P.showConfirmModal=e),title:"支付确认","show-cancel-button":"","confirm-text":"已完成支付","confirm-color":e.appTheme.mainBg,"negative-top":"100",asyncClose:!0,onConfirm:h[2]||(h[2]=e=>S.onTradeQuery(P.tempUnifyData.outTradeNo,P.tempUnifyData.method))},{default:o((()=>[s(b,{class:"modal-content"},{default:o((()=>[s(v,null,{default:o((()=>[r("请在"+l(P.PayMethodClientNameEnum[P.tempUnifyData.method])+"内完成支付，如果您已经支付成功，请点击“已完成支付”按钮",1)])),_:1})])),_:1})])),_:1},8,["modelValue","confirm-color"])):i("",!0)])),_:1},8,["style"]))}],["__scopeId","data-v-69a8d123"]]);export{j as default};
